/*
===============================================================================
Quality Checks
===============================================================================
Script Purpose:
    This script performs various quality checks for data consistency, accuracy, 
    and standardization across the 'silver' layer. It includes checks for:
    - Null or duplicate primary keys.
    - Unwanted spaces in string fields.
    - Data standardization and consistency.
    - Invalid date ranges and orders.
    - Data consistency between related fields.

Usage Notes:
    - Run these checks after data loading Silver Layer.
    - Investigate and resolve any discrepancies found during the checks.
===============================================================================
*/
--CRM SOURCE
--Check for NULLs or duplicates in primary key
SELECT 
cst_id,
COUNT(*)
FROM silver.crm_cust_info
GROUP BY cst_id
HAVING COUNT(*)>1 OR cst_id IS NULL

SELECT *FROM bronze.crm_cust_info
WHERE cst_id=29466

SELECT* FROM(
SELECT*,
ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC)AS FLAG 
FROM silver.crm_cust_info
)t WHERE FLAG=1


--Check for unwanted spaces
SELECT  cst_firstname
FROM silver.crm_cust_info
WHERE cst_firstname!= TRIM(cst_firstname)

--Data standardization and consistency + changing NULL to n\a
SELECT DISTINCT cs_gndr
FROM silver.crm_cust_info --now using case

--prd_info

--Checking for null or duplicates in primary key
SELECT 
prd_id,
COUNT(*)
FROM silver.crm_prd_info
GROUP BY prd_id
HAVING prd_id IS NULL OR COUNT(*)>1

--Creating substring useful for joining
SELECT *,
REPLACE(SUBSTRING(prd_key,1,5),'-','_')AS cat_id,
SUBSTRING(prd_key,7,LEN(prd_key))AS prd_key
FROM silver.crm_prd_info

--Checking for unwanted spaces
SELECT*
FROM silver.crm_prd_info
WHERE prd_nm != TRIM(prd_nm)

--Checking for cost to negative or null
SELECT *
FROM silver.crm_prd_info
WHERE prd_cost IS NULL OR prd_cost <1

--Elaborating abbreviations
SELECT *
CASE prd_line
	WHEN 'R' THEN 'Road',
	WHEN 'M' THEN 'Mountain'
	WHEN 'S' THEN 'Other Sales'
	WHEN 'T' THEN 'Touring'
	ELSE 'n/a'
END prd_line

--Handling dates
SELECT *
FROM silver.crm_prd_info
WHERE prd_end_dt<prd_start_dt
SELECT *, 
CAST(LEAD(prd_start_dt) OVER(PARTITION BY prd_key ORDER BY prd_start_dt ) -1 AS DATE) AS prd_end_dt_clean
FROM silver.crm_prd_info

SELECT * FROM silver.crm_sales_details
WHERE sls_ord_num != TRIM(sls_ord_num)

SELECT * FROM silver.crm_sales_details
WHERE sls_prd_key NOT IN (SELECT SUBSTRING(prd_key,7,LEN(prd_key)) FROM bronze.crm_prd_info)--or (SELECT prd_key FROM silver.crm_prd_info)

SELECT * FROM silver.crm_sales_details
WHERE sls_cust_id NOT IN (SELECT cst_id FROM silver.crm_cust_info)--or (SELECT cst_id FROM bronze.crm_cust_info)

SELECT 
NULLIF(sls_order_dt,0) sls_order_dt
FROM silver.crm_sales_details
WHERE sls_order_dt <=0
OR LEN(sls_order_dt)!=8
OR sls_order_dt> 20500101 OR sls_order_dt< 19000101

--ERP SOURCE
SELECT 
CASE WHEN CID LIKE 'NAS%' THEN SUBSTRING(CID,4,LEN(CID))
	ELSE CID
END AS CID
FROM silver.erp_CUST_AZ12
WHERE CASE WHEN CID LIKE 'NAS%' THEN SUBSTRING(CID,4,LEN(CID))
	ELSE CID
END NOT IN(SELECT DISTINCT cst_key FROM silver.crm_cust_info) 

SELECT * FROM silver.erp_CUST_AZ12 WHERE BDATE > GETDATE() --PROB
CASE WHEN BDATE>GETDATE() THEN NULL--Add lower bound also if needed--SOLUTION
	ELSE BDATE
END AS BDATE,

SELECT DISTINCT GENDER FROM silver.erp_CUST_AZ12--PROB
CASE WHEN UPPER(TRIM(GENDER)) IN('M','Male')THEN 'Male'--SOLUTION
	when UPPER(TRIM(GENDER)) IN('F','Female')THEN 'Female'
	ELSE 'n/a'
END AS GENDER

--NEW QUERY 2.
SELECT DISTINCT CNTRY FROM silver.erp_LOC_A101

--NEW QUERY 3.
SELECT TRIM(ID) AS ID
FROM silver.erp_PX_CAT_G1V2
WHERE ID NOT IN (SELECT cat_id FROM silver.crm_prd_info )--NOT EXISTS

--4.UNWANTED SPACE
SELECT* FROM silver.erp_PX_CAT_G1V2
WHERE TRIM(ID) != ID OR TRIM(CAT)!= CAT OR TRIM(SUBCAT) != SUBCAT

--5.
SELECT DISTINCT CAT FROM silver.erp_PX_CAT_G1V2
SELECT DISTINCT SUBCAT FROM silver.erp_PX_CAT_G1V2
SELECT DISTINCT MAINTENANCE FROM silver.erp_PX_CAT_G1V2




