/*
===============================================================================
Quality Checks
===============================================================================
Script Purpose:
    This script performs quality checks to validate the integrity, consistency, 
    and accuracy of the Gold Layer. These checks ensure:
    - Uniqueness of surrogate keys in dimension tables.
    - Referential integrity between fact and dimension tables.
    - Validation of relationships in the data model for analytical purposes.

Usage Notes:
    - Investigate and resolve any discrepancies found during the checks.
===============================================================================
*/
SELECT CUSTOMER_ID , COUNT(*)FROM(--duplicates checking
SELECT 
ci.cst_id AS CUSTOMER_ID,
ci.cst_key AS CUSTOMER_NUMBER,
ci.cst_firstname AS FIRSTNAME,
ci.cst_lastname AS LASTNAME,
ci.cst_marital_status AS MARITAL_STATUS,
ci.cs_gndr AS GEN,
ci.cst_create_date AS CREATE_DATE,
la.CNTRY AS COUNTRY,
ca.BDATE AS BIRTHDATE,
ca.GENDER AS GENDER
FROM silver.crm_cust_info AS ci
LEFT JOIN silver.erp_CUST_AZ12 AS ca
ON ci.cst_key=ca.CID
LEFT JOIN silver.erp_LOC_A101 AS la
ON la.CID=ci.cst_key)t GROUP BY CUSTOMER_ID
HAVING COUNT(*)>1

SELECT DISTINCT--improve gender quality 
ci.cs_gndr,
ca.GENDER,
CASE WHEN ci.cs_gndr !='n/a' THEN ci.cs_gndr
	ELSE COALESCE(ca.GENDER,'n/a')
END
FROM silver.crm_cust_info AS ci
LEFT JOIN silver.erp_CUST_AZ12 AS ca
ON ci.cst_key=ca.CID
LEFT JOIN silver.erp_LOC_A101 AS la
ON la.CID=ci.cst_key

--quality check for gold (customers)
SELECT *FROM gold.dim_customers
SELECT DISTINCT GENDER FROM gold.dim_customers

--gold.dim_products
SELECT prd_id,COUNT(*)FROM(
SELECT
--ROW_NUMBER()OVER(ORDER BY prd_id)
pn.prd_id,--4.renaming cols+5.sorting cols+6.dim/fact
pn.prd_key,
pn.prd_nm,
pn.cat_id,
pc.CAT,
pc.SUBCAT,
pc.MAINTENANCE,
pn.prd_cost,
pn.prd_line,
pn.prd_start_dt,
--3.pn.prd_dt(remove this col after removing historical data and present data's end date gets null)
--pc.ID
FROM silver.crm_prd_info AS pn
LEFT JOIN silver.erp_PX_CAT_G1V2 AS pc--1.joining tables
ON pn.cat_id=pc.ID)t GROUP BY prd_id
HAVING COUNT(*)>1--2. remove duplicate

SELECT DISTINCT pn.cat_id,pc.ID
FROM silver.crm_prd_info AS pn
LEFT JOIN silver.erp_PX_CAT_G1V2 AS pc
ON pn.cat_id=pc.ID

SELECT* FROM gold.dim_customers
SELECT* FROM gold.dim_products
SELECT*FROM gold.fact_sales f
--Foreign Key Integrity(Dimensions)
LEFT JOIN gold.dim_customers c
ON c.CUSTOMER_KEY=f.CUSTOMER_KEY
LEFT JOIN gold.dim_products p
ON p.product_key=f.PRODUCT_KEY
--WHERE c.CUSTOMER_ID IS NULL 
WHERE p.product_key IS NULL
